name: Composite Build CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout bazel-app
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Clone producer repositories
        run: |
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            name=$(yq ".producers[$i].name" PRODUCERS.yaml)
            repo=$(yq ".producers[$i].repository" PRODUCERS.yaml)
            ref=$(yq ".producers[$i].ref" PRODUCERS.yaml)
            path=$(yq ".producers[$i].path" PRODUCERS.yaml)

            echo "Cloning producer: $name ($repo @ $ref) into $path"
            git clone --branch "$ref" --single-branch --depth 1 "$repo" "$path"
          done

      - name: Wire Bazel producers (MODULE.bazel)
        run: |
          echo ""
          echo "--- Wiring Bazel producers ---"
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            build_system=$(yq ".producers[$i].build_system" PRODUCERS.yaml)
            if [ "$build_system" != "bazel" ]; then
              continue
            fi

            name=$(yq ".producers[$i].name" PRODUCERS.yaml)
            path=$(yq ".producers[$i].path" PRODUCERS.yaml)

            echo "" >> MODULE.bazel
            echo "bazel_dep(name = \"$name\", version = \"1.0.0\")" >> MODULE.bazel
            echo "local_path_override(" >> MODULE.bazel
            echo "    module_name = \"$name\"," >> MODULE.bazel
            echo "    path = \"$path\"," >> MODULE.bazel
            echo ")" >> MODULE.bazel

            echo "Added bazel_dep + local_path_override for $name -> $path"
          done
          echo ""
          echo "Generated MODULE.bazel:"
          cat MODULE.bazel

      - name: Wire Gradle producers (build JAR + third_party)
        run: |
          echo ""
          echo "--- Wiring Gradle producers ---"
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            build_system=$(yq ".producers[$i].build_system" PRODUCERS.yaml)
            if [ "$build_system" != "gradle" ]; then
              continue
            fi

            name=$(yq ".producers[$i].name" PRODUCERS.yaml)
            path=$(yq ".producers[$i].path" PRODUCERS.yaml)
            build_command=$(yq ".producers[$i].build_command" PRODUCERS.yaml)
            jar_path=$(yq ".producers[$i].jar_path" PRODUCERS.yaml)

            echo "Building Gradle producer: $name"
            pushd "$path"
            chmod +x gradlew
            $build_command
            popd

            # Copy JAR to third_party
            mkdir -p "third_party/$name"
            jar_filename=$(basename "$jar_path")
            cp "$path/$jar_path" "third_party/$name/$jar_filename"
            echo "Copied $jar_filename to third_party/$name/"

            # Generate java_import BUILD file
            cat > "third_party/$name/BUILD" << EOF
            load("@rules_java//java:defs.bzl", "java_import")

            java_import(
                name = "library",
                jars = ["$jar_filename"],
                visibility = ["//visibility:public"],
            )
          EOF

            echo "Generated third_party/$name/BUILD:"
            cat "third_party/$name/BUILD"
          done

      - name: Generate composite BUILD
        run: |
          echo ""
          echo "--- Generating composite BUILD ---"

          # Collect all dep labels from all producers
          DEPS=""
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            build_system=$(yq ".producers[$i].build_system" PRODUCERS.yaml)
            name=$(yq ".producers[$i].name" PRODUCERS.yaml)

            if [ "$build_system" = "bazel" ]; then
              target_count=$(yq ".producers[$i].targets | length" PRODUCERS.yaml)
              for j in $(seq 0 $(( target_count - 1 ))); do
                target=$(yq ".producers[$i].targets[$j]" PRODUCERS.yaml)
                DEPS="$DEPS        \"@${name}${target}\","$'\n'
              done
            elif [ "$build_system" = "gradle" ]; then
              third_party_target=$(yq ".producers[$i].third_party_target" PRODUCERS.yaml)
              DEPS="$DEPS        \"${third_party_target}\","$'\n'
            fi
          done

          # Rewrite BUILD with deps injected
          cat > BUILD << EOF
          load("@rules_java//java:defs.bzl", "java_binary")

          java_binary(
              name = "app",
              srcs = glob(["src/main/java/com/example/app/*.java"]),
              main_class = "com.example.app.App",
              deps = [
          ${DEPS}    ],
          )
          EOF

          echo "Generated BUILD:"
          cat BUILD

      - name: Generate composite App.java
        run: |
          echo ""
          echo "--- Generating composite App.java ---"

          APP_FILE="src/main/java/com/example/app/App.java"

          # Collect imports and calls from all producers
          IMPORTS=""
          CALLS=""
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            import_count=$(yq ".producers[$i].imports | length" PRODUCERS.yaml)
            for j in $(seq 0 $(( import_count - 1 ))); do
              class=$(yq ".producers[$i].imports[$j].class" PRODUCERS.yaml)
              call=$(yq ".producers[$i].imports[$j].call" PRODUCERS.yaml)
              IMPORTS="${IMPORTS}import ${class};"$'\n'
              CALLS="${CALLS}        ${call};"$'\n'
            done
          done

          cat > "$APP_FILE" << EOF
          package com.example.app;

          ${IMPORTS}
          public class App {
              public static void main(String[] args) {
                  System.out.println("I love bazel");
          ${CALLS}    }
          }
          EOF

          echo "Generated App.java:"
          cat "$APP_FILE"

      - name: Verify producer layout
        run: |
          echo "Directory layout:"
          ls -la ..
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            path=$(yq ".producers[$i].path" PRODUCERS.yaml)
            name=$(yq ".producers[$i].name" PRODUCERS.yaml)
            if [ -d "$path" ]; then
              echo "Producer '$name' found at $path"
            else
              echo "ERROR: Producer '$name' not found at $path"
              exit 1
            fi
          done

      - name: Build composite
        run: bazel build //:app

      - name: Run composite
        run: bazel run //:app
