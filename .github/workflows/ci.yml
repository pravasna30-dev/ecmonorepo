name: Composite Build CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout bazel-app
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Install target-determinator
        run: |
          sudo curl -sL -o /usr/local/bin/target-determinator \
            https://github.com/bazel-contrib/target-determinator/releases/download/v0.32.0/target-determinator.linux.amd64
          sudo chmod +x /usr/local/bin/target-determinator

      - name: Clone producer repositories
        run: |
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            name=$(yq ".producers[$i].name" PRODUCERS.yaml)
            repo=$(yq ".producers[$i].repository" PRODUCERS.yaml)
            ref=$(yq ".producers[$i].ref" PRODUCERS.yaml)
            path=$(yq ".producers[$i].path" PRODUCERS.yaml)

            echo "Cloning producer: $name ($repo @ $ref) into $path"
            git clone --branch "$ref" --single-branch --depth 1 "$repo" "$path"
          done

      - name: Wire Bazel producers (MODULE.bazel)
        run: |
          echo ""
          echo "--- Wiring Bazel producers ---"
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            build_system=$(yq ".producers[$i].build_system" PRODUCERS.yaml)
            if [ "$build_system" != "bazel" ]; then
              continue
            fi

            name=$(yq ".producers[$i].name" PRODUCERS.yaml)
            path=$(yq ".producers[$i].path" PRODUCERS.yaml)

            echo "" >> MODULE.bazel
            echo "bazel_dep(name = \"$name\", version = \"1.0.0\")" >> MODULE.bazel
            echo "local_path_override(" >> MODULE.bazel
            echo "    module_name = \"$name\"," >> MODULE.bazel
            echo "    path = \"$path\"," >> MODULE.bazel
            echo ")" >> MODULE.bazel

            echo "Added bazel_dep + local_path_override for $name -> $path"
          done
          echo ""
          echo "Generated MODULE.bazel:"
          cat MODULE.bazel

      - name: Wire source producers (copy sources + java_library)
        run: |
          echo ""
          echo "--- Wiring source producers ---"
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            build_system=$(yq ".producers[$i].build_system" PRODUCERS.yaml)
            if [ "$build_system" != "source" ]; then
              continue
            fi

            name=$(yq ".producers[$i].name" PRODUCERS.yaml)
            path=$(yq ".producers[$i].path" PRODUCERS.yaml)
            source_root=$(yq ".producers[$i].source_root" PRODUCERS.yaml)
            package_name=$(yq ".producers[$i].package_name" PRODUCERS.yaml)

            echo "Copying sources for producer: $name"
            mkdir -p "$package_name/src/main/java"
            cp -r "$path/$source_root/"* "$package_name/src/main/java/"
            echo "Copied $path/$source_root/ -> $package_name/src/main/java/"

            # Generate java_library BUILD file
            cat > "$package_name/BUILD" << 'EOF'
          load("@rules_java//java:defs.bzl", "java_library")

          java_library(
              name = "library",
              srcs = glob(["src/main/java/**/*.java"]),
              visibility = ["//visibility:public"],
          )
          EOF

            echo "Generated $package_name/BUILD:"
            cat "$package_name/BUILD"
            echo ""
            echo "Source files:"
            find "$package_name" -name "*.java" -type f
          done

      - name: Generate composite BUILD
        run: |
          echo ""
          echo "--- Generating composite BUILD ---"

          # Collect all dep labels from all producers
          DEPS=""
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            build_system=$(yq ".producers[$i].build_system" PRODUCERS.yaml)
            name=$(yq ".producers[$i].name" PRODUCERS.yaml)

            if [ "$build_system" = "bazel" ]; then
              target_count=$(yq ".producers[$i].targets | length" PRODUCERS.yaml)
              for j in $(seq 0 $(( target_count - 1 ))); do
                target=$(yq ".producers[$i].targets[$j]" PRODUCERS.yaml)
                DEPS="$DEPS        \"@${name}${target}\","$'\n'
              done
            elif [ "$build_system" = "source" ]; then
              target=$(yq ".producers[$i].target" PRODUCERS.yaml)
              DEPS="$DEPS        \"${target}\","$'\n'
            fi
          done

          # Rewrite BUILD with deps injected
          cat > BUILD << EOF
          load("@rules_java//java:defs.bzl", "java_binary")

          java_binary(
              name = "app",
              srcs = glob(["src/main/java/com/example/app/*.java"]),
              main_class = "com.example.app.App",
              deps = [
          ${DEPS}    ],
          )
          EOF

          echo "Generated BUILD:"
          cat BUILD

      - name: Generate composite App.java
        run: |
          echo ""
          echo "--- Generating composite App.java ---"

          APP_FILE="src/main/java/com/example/app/App.java"

          # Collect imports and calls from all producers
          IMPORTS=""
          CALLS=""
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            import_count=$(yq ".producers[$i].imports | length" PRODUCERS.yaml)
            for j in $(seq 0 $(( import_count - 1 ))); do
              class=$(yq ".producers[$i].imports[$j].class" PRODUCERS.yaml)
              call=$(yq ".producers[$i].imports[$j].call" PRODUCERS.yaml)
              IMPORTS="${IMPORTS}import ${class};"$'\n'
              CALLS="${CALLS}        ${call};"$'\n'
            done
          done

          cat > "$APP_FILE" << EOF
          package com.example.app;

          ${IMPORTS}
          public class App {
              public static void main(String[] args) {
                  System.out.println("I love bazel");
          ${CALLS}    }
          }
          EOF

          echo "Generated App.java:"
          cat "$APP_FILE"

      - name: Commit generated composite build
        run: |
          git add -A
          git -c user.name="CI" -c user.email="ci@noreply" commit -m "Generated composite build" --allow-empty

      - name: Determine affected targets
        run: |
          echo "--- Affected targets (comparing against previous commit) ---"
          target-determinator HEAD~1 -verbose || true

      - name: Verify producer layout
        run: |
          echo "Directory layout:"
          ls -la ..
          count=$(yq '.producers | length' PRODUCERS.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            path=$(yq ".producers[$i].path" PRODUCERS.yaml)
            name=$(yq ".producers[$i].name" PRODUCERS.yaml)
            if [ -d "$path" ]; then
              echo "Producer '$name' found at $path"
            else
              echo "ERROR: Producer '$name' not found at $path"
              exit 1
            fi
          done

      - name: Build composite
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            AFFECTED=$(target-determinator HEAD~1 2>/dev/null || echo "")
            if [ -n "$AFFECTED" ]; then
              echo "Building affected targets only:"
              echo "$AFFECTED"
              echo "$AFFECTED" | xargs bazel build
            else
              echo "No affected targets detected, building all"
              bazel build //:app
            fi
          else
            bazel build //:app
          fi

      - name: Run composite
        run: bazel run //:app
