name: Composite Build CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout bazel-app
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Clone producer repositories
        run: |
          count=$(yq '.producers | length' producer.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            name=$(yq ".producers[$i].name" producer.yaml)
            repo=$(yq ".producers[$i].repository" producer.yaml)
            ref=$(yq ".producers[$i].ref" producer.yaml)
            path=$(yq ".producers[$i].path" producer.yaml)

            echo "Cloning producer: $name ($repo @ $ref) into $path"
            git clone --branch "$ref" --single-branch --depth 1 "$repo" "$path"
          done

      - name: Generate composite MODULE.bazel
        run: |
          echo ""
          echo "--- Generating composite MODULE.bazel ---"
          count=$(yq '.producers | length' producer.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            name=$(yq ".producers[$i].name" producer.yaml)
            path=$(yq ".producers[$i].path" producer.yaml)

            echo "" >> MODULE.bazel
            echo "bazel_dep(name = \"$name\", version = \"1.0.0\")" >> MODULE.bazel
            echo "local_path_override(" >> MODULE.bazel
            echo "    module_name = \"$name\"," >> MODULE.bazel
            echo "    path = \"$path\"," >> MODULE.bazel
            echo ")" >> MODULE.bazel

            echo "Added bazel_dep + local_path_override for $name -> $path"
          done
          echo ""
          echo "Generated MODULE.bazel:"
          cat MODULE.bazel

      - name: Generate composite BUILD
        run: |
          echo ""
          echo "--- Generating composite BUILD ---"

          # Collect all dep labels from all producers
          DEPS=""
          count=$(yq '.producers | length' producer.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            name=$(yq ".producers[$i].name" producer.yaml)
            target_count=$(yq ".producers[$i].targets | length" producer.yaml)
            for j in $(seq 0 $(( target_count - 1 ))); do
              target=$(yq ".producers[$i].targets[$j]" producer.yaml)
              DEPS="$DEPS        \"@${name}${target}\","$'\n'
            done
          done

          # Rewrite BUILD with deps injected
          cat > BUILD << EOF
          load("@rules_java//java:defs.bzl", "java_binary")

          java_binary(
              name = "app",
              srcs = glob(["src/main/java/com/example/app/*.java"]),
              main_class = "com.example.app.App",
              deps = [
          ${DEPS}    ],
          )
          EOF

          echo "Generated BUILD:"
          cat BUILD

      - name: Verify producer layout
        run: |
          echo "Directory layout:"
          ls -la ..
          count=$(yq '.producers | length' producer.yaml)
          for i in $(seq 0 $(( count - 1 ))); do
            path=$(yq ".producers[$i].path" producer.yaml)
            name=$(yq ".producers[$i].name" producer.yaml)
            if [ -d "$path" ]; then
              echo "Producer '$name' found at $path"
            else
              echo "ERROR: Producer '$name' not found at $path"
              exit 1
            fi
          done

      - name: Build composite
        run: bazel build //:app

      - name: Run composite
        run: bazel run //:app
